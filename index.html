<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wi-Fi Direct Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.3s; }
        .slide-up { animation: slideUp 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .message-sent { background-color: #3b82f6; color: white; border-radius: 18px 18px 4px 18px; }
        .message-received { background-color: #f1f5f9; color: #334155; border-radius: 18px 18px 18px 4px; }
        .pulse-online { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .typing-indicator { display: inline-block; position: relative; }
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #6b7280; margin: 0 1px; animation: typing 1.4s infinite ease-in-out; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }
        .friend-item:hover { background-color: #f8fafc; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- User Registration Screen -->
        <div id="registerScreen" class="p-6 fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-md">
                    <i class="fas fa-wifi text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">Wi-Fi Direct Chat</h1>
                <p class="text-gray-600 mt-2">Connect with friends on the same network</p>
            </div>
            
            <form id="registerForm" class="space-y-6">
                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                    <input 
                        type="text" 
                        id="userName" 
                        required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                        placeholder="Enter your name"
                    >
                </div>
                
                <div>
                    <label for="userId" class="block text-sm font-medium text-gray-700 mb-2">Your 6-Digit ID</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="userId" 
                            maxlength="6" 
                            pattern="\d{6}" 
                            required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-center text-lg font-semibold tracking-widest"
                            placeholder="123456"
                        >
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <i class="fas fa-id-card text-gray-400"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">This ID will be used to identify you in the network</p>
                </div>
                
                <button 
                    type="submit" 
                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-medium py-3 px-4 rounded-lg transition flex items-center justify-center shadow-md"
                >
                    <i class="fas fa-user-plus mr-2"></i> Create Profile
                </button>
            </form>
            
            <div class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h3 class="font-medium text-blue-800 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i> How it works
                </h3>
                <ul class="text-sm text-blue-700 mt-2 space-y-2">
                    <li class="flex items-start">
                        <i class="fas fa-wifi mr-2 mt-1"></i>
                        <span>Connect to the same Wi-Fi network</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-user-friends mr-2 mt-1"></i>
                        <span>Send friend requests using IDs</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-comments mr-2 mt-1"></i>
                        <span>Chat with friends when both are online</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Main Dashboard Screen -->
        <div id="dashboardScreen" class="hidden h-screen flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 flex items-center justify-between shadow-lg">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <h2 class="font-semibold" id="userNameDisplay">User</h2>
                        <p class="text-blue-100 text-xs flex items-center">
                            <i class="fas fa-id-card mr-1"></i> ID: <span id="userIdDisplay" class="ml-1 font-mono">---</span>
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="wifiStatus" class="w-3 h-3 bg-green-400 rounded-full pulse-online"></div>
                    <span class="text-sm">Online</span>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-200 bg-white">
                <button id="friendsTab" class="flex-1 py-3 text-center font-medium text-blue-600 border-b-2 border-blue-500">
                    <i class="fas fa-user-friends mr-2"></i>Friends
                </button>
                <button id="addFriendTab" class="flex-1 py-3 text-center font-medium text-gray-500">
                    <i class="fas fa-user-plus mr-2"></i>Add Friend
                </button>
            </div>
            
            <!-- Friends List -->
            <div id="friendsListContainer" class="flex-1 p-4 overflow-y-auto bg-white">
                <h3 class="font-medium text-gray-700 mb-3">My Friends</h3>
                <div id="friendsList" class="space-y-2">
                    <!-- Friends will be dynamically added here -->
                </div>
                
                <div id="noFriendsMessage" class="text-center py-8 text-gray-500">
                    <i class="fas fa-user-friends text-3xl mb-3 text-gray-300"></i>
                    <p>No friends yet. Add some friends to start chatting!</p>
                </div>
            </div>
            
            <!-- Add Friend Section -->
            <div id="addFriendContainer" class="hidden flex-1 p-4 overflow-y-auto bg-white">
                <h3 class="font-medium text-gray-700 mb-3">Add New Friend</h3>
                
                <form id="addFriendForm" class="mb-6">
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="friendIdInput" 
                            maxlength="6" 
                            pattern="\d{6}" 
                            required 
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-center font-semibold tracking-widest"
                            placeholder="Friend's ID"
                        >
                        <button 
                            type="submit" 
                            class="bg-blue-500 hover:bg-blue-600 text-white rounded-lg px-4 flex items-center justify-center transition"
                        >
                            <i class="fas fa-user-plus mr-2"></i> Add
                        </button>
                    </div>
                    <div id="friendIdError" class="text-red-500 text-sm mt-2 hidden">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        <span id="errorMessage"></span>
                    </div>
                </form>
                
                <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h4 class="font-medium text-blue-800 flex items-center">
                        <i class="fas fa-lightbulb mr-2"></i> How to add friends
                    </h4>
                    <ul class="text-sm text-blue-700 mt-2 space-y-2">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mr-2 mt-1 text-green-500"></i>
                            <span>Both users must be on the same Wi-Fi network</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mr-2 mt-1 text-green-500"></i>
                            <span>Enter your friend's 6-digit ID</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle mr-2 mt-1 text-green-500"></i>
                            <span>They'll receive a friend request notification</span>
                        </li>
                    </ul>
                </div>
                
                <h3 class="font-medium text-gray-700 mb-3">Pending Requests</h3>
                <div id="pendingRequestsList" class="space-y-2">
                    <!-- Pending requests will be dynamically added here -->
                </div>
                
                <div id="noPendingRequests" class="text-center py-4 text-gray-500">
                    <p>No pending friend requests</p>
                </div>
            </div>
        </div>
        
        <!-- Chat Screen -->
        <div id="chatScreen" class="hidden h-screen flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 flex items-center justify-between shadow-lg">
                <div class="flex items-center">
                    <button id="backToDashboard" class="mr-3 bg-white/20 hover:bg-white/30 p-2 rounded-full transition">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h2 class="font-semibold" id="chatPartnerName">Friend</h2>
                        <p class="text-blue-100 text-xs flex items-center">
                            <i class="fas fa-id-card mr-1"></i> ID: <span id="chatPartnerId" class="ml-1 font-mono">---</span>
                            <span id="partnerStatus" class="ml-2 flex items-center">
                                <span class="w-2 h-2 bg-gray-400 rounded-full mr-1"></span>
                                <span>Offline</span>
                            </span>
                        </p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="chatConnectionIndicator" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                    <span class="text-sm" id="chatConnectionStatus">Offline</span>
                </div>
            </div>
            
            <!-- Messages Container -->
            <div id="messagesContainer" class="flex-1 p-4 overflow-y-auto space-y-3 bg-gradient-to-b from-white to-blue-50">
                <div class="text-center text-gray-500 text-sm py-8">
                    <i class="fas fa-comment-dots text-3xl mb-3 block text-blue-300"></i>
                    <p>No messages yet. Start a conversation!</p>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div id="typingIndicator" class="hidden px-4 py-2 bg-white">
                <div class="text-sm text-gray-500 italic flex items-center">
                    <span id="typingPartnerName" class="font-semibold mr-1"></span> is typing
                    <div class="typing-indicator ml-2">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
            
            <!-- Message Input -->
            <div class="border-t border-gray-200 p-4 bg-white">
                <div class="flex space-x-2">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Type a message..." 
                        class="flex-1 border border-gray-300 rounded-full px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                        maxlength="200"
                        disabled
                    >
                    <button 
                        id="sendButton" 
                        class="bg-gray-400 text-white rounded-full w-12 h-12 flex items-center justify-center transition"
                        disabled
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        const appState = {
            userId: null,
            userName: null,
            friends: [],
            pendingRequests: [],
            currentChatPartner: null,
            isConnectedToWifi: false,
            messages: {},
            onlineUsers: [],
            typingTimeout: null,
            // Track all registered users in the network
            networkUsers: {}
        };

        // DOM Elements
        const registerScreen = document.getElementById('registerScreen');
        const dashboardScreen = document.getElementById('dashboardScreen');
        const chatScreen = document.getElementById('chatScreen');
        const registerForm = document.getElementById('registerForm');
        const userNameInput = document.getElementById('userName');
        const userIdInput = document.getElementById('userId');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const friendsTab = document.getElementById('friendsTab');
        const addFriendTab = document.getElementById('addFriendTab');
        const friendsListContainer = document.getElementById('friendsListContainer');
        const addFriendContainer = document.getElementById('addFriendContainer');
        const friendsList = document.getElementById('friendsList');
        const noFriendsMessage = document.getElementById('noFriendsMessage');
        const addFriendForm = document.getElementById('addFriendForm');
        const friendIdInput = document.getElementById('friendIdInput');
        const friendIdError = document.getElementById('friendIdError');
        const errorMessage = document.getElementById('errorMessage');
        const pendingRequestsList = document.getElementById('pendingRequestsList');
        const noPendingRequests = document.getElementById('noPendingRequests');
        const backToDashboard = document.getElementById('backToDashboard');
        const chatPartnerName = document.getElementById('chatPartnerName');
        const chatPartnerId = document.getElementById('chatPartnerId');
        const partnerStatus = document.getElementById('partnerStatus');
        const chatConnectionIndicator = document.getElementById('chatConnectionIndicator');
        const chatConnectionStatus = document.getElementById('chatConnectionStatus');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const typingPartnerName = document.getElementById('typingPartnerName');
        const wifiStatus = document.getElementById('wifiStatus');

        // Initialize the app
        function initApp() {
            // Check if user is already registered
            const storedUser = localStorage.getItem('wifiChatUser');
            if (storedUser) {
                const userData = JSON.parse(storedUser);
                appState.userId = userData.userId;
                appState.userName = userData.userName;
                appState.friends = userData.friends || [];
                appState.pendingRequests = userData.pendingRequests || [];
                appState.messages = userData.messages || {};
                
                showDashboard();
            }
            
            // Set up event listeners
            registerForm.addEventListener('submit', handleUserRegistration);
            friendsTab.addEventListener('click', () => switchTab('friends'));
            addFriendTab.addEventListener('click', () => switchTab('addFriend'));
            addFriendForm.addEventListener('submit', handleAddFriend);
            backToDashboard.addEventListener('click', showDashboard);
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            messageInput.addEventListener('input', handleTyping);
            
            // Validate numeric input for ID fields
            [userIdInput, friendIdInput].forEach(input => {
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
            });
            
            // Initialize network simulation
            initNetworkSimulation();
            
            // Check Wi-Fi connection status
            checkWifiConnection();
            setInterval(checkWifiConnection, 5000);
            
            // Update online status
            setInterval(updateOnlineStatus, 3000);
            
            // Load network users
            loadNetworkUsers();
        }

        // Load all registered users in the network
        function loadNetworkUsers() {
            // Scan localStorage for all registered users
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key === 'wifiChatUser' || key.startsWith('wifiChatUser_')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        if (userData && userData.userId) {
                            appState.networkUsers[userData.userId] = {
                                name: userData.userName,
                                lastSeen: Date.now()
                            };
                        }
                    } catch (error) {
                        console.error('Error loading user data:', error);
                    }
                }
            }
        }

        // Initialize network simulation
        function initNetworkSimulation() {
            // Use localStorage to simulate network communication
            window.addEventListener('storage', handleNetworkEvent);
            
            // Also check for messages periodically
            setInterval(checkForNetworkEvents, 1000);
        }

        // Check for network events
        function checkForNetworkEvents() {
            // Check for messages and requests targeted to this user
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('wifiChat_')) {
                    try {
                        const message = JSON.parse(localStorage.getItem(key));
                        if (message && message.targetId === appState.userId) {
                            processIncomingMessage(message);
                            // Remove the message after processing
                            localStorage.removeItem(key);
                        }
                    } catch (error) {
                        console.error('Error checking for messages:', error);
                    }
                }
            }
            
            // Update friends list with online status
            updateFriendsList();
        }

        // Handle network events
        function handleNetworkEvent(e) {
            if (e.key && e.key.startsWith('wifiChat_')) {
                try {
                    const message = JSON.parse(e.newValue);
                    if (message && message.targetId === appState.userId) {
                        processIncomingMessage(message);
                    }
                } catch (error) {
                    console.error('Error processing network message:', error);
                }
            }
        }

        // Process incoming message
        function processIncomingMessage(message) {
            if (message.type === 'friendRequest') {
                receiveFriendRequest(message.senderId, message.senderName);
            } else if (message.type === 'friendRequestAccepted') {
                handleFriendRequestAccepted(message.senderId, message.senderName);
            } else if (message.type === 'chat') {
                receiveMessage(message.data);
            } else if (message.type === 'typing') {
                showTypingIndicator(message.senderId, message.senderName);
            } else if (message.type === 'onlineStatus') {
                updateOnlineUserStatus(message.senderId, message.data);
            } else if (message.type === 'userValidation') {
                // Response to user validation request
                if (message.data === 'userExists' && message.requestId) {
                    handleUserValidationResponse(message.requestId, true);
                }
            }
        }

        // Check Wi-Fi connection (simulated)
        function checkWifiConnection() {
            // In a real app, this would check actual network connectivity
            // For simulation, we'll assume we're always connected to Wi-Fi
            appState.isConnectedToWifi = true;
            wifiStatus.className = "w-3 h-3 bg-green-400 rounded-full pulse-online";
            
            // Broadcast online status
            if (appState.userId) {
                broadcastOnlineStatus();
            }
        }

        // Broadcast online status to network
        function broadcastOnlineStatus() {
            sendNetworkMessage({
                type: 'onlineStatus',
                data: 'online',
                senderId: appState.userId,
                senderName: appState.userName,
                targetId: 'broadcast' // Send to all users
            });
        }

        // Update online user status
        function updateOnlineUserStatus(userId, status) {
            // Add to online users list
            const existingIndex = appState.onlineUsers.findIndex(user => user.id === userId);
            if (existingIndex >= 0) {
                appState.onlineUsers[existingIndex].lastSeen = Date.now();
            } else {
                appState.onlineUsers.push({
                    id: userId,
                    lastSeen: Date.now()
                });
            }
            
            // Update friends list if needed
            updateFriendsList();
            
            // Update chat status if currently chatting with this user
            if (appState.currentChatPartner && appState.currentChatPartner.id === userId) {
                updateChatConnectionStatus();
            }
        }

        // Update online status periodically
        function updateOnlineStatus() {
            // Remove users who haven't been seen in 10 seconds
            const now = Date.now();
            appState.onlineUsers = appState.onlineUsers.filter(user => 
                now - user.lastSeen < 10000
            );
            
            // Update friends list
            updateFriendsList();
            
            // Update chat status if needed
            if (appState.currentChatPartner) {
                updateChatConnectionStatus();
            }
        }

        // Handle user registration
        function handleUserRegistration(e) {
            e.preventDefault();
            const userName = userNameInput.value.trim();
            const userId = userIdInput.value.trim();
            
            if (!userName) {
                showNotification('Please enter your name', 'error');
                return;
            }
            
            if (userId.length !== 6) {
                showNotification('Please enter a 6-digit ID', 'error');
                return;
            }
            
            // Check if ID is already taken in the network
            if (isUserIdTaken(userId)) {
                showNotification('This ID is already taken. Please choose a different one.', 'error');
                userIdInput.classList.add('shake');
                setTimeout(() => userIdInput.classList.remove('shake'), 500);
                return;
            }
            
            // Store user data
            appState.userId = userId;
            appState.userName = userName;
            
            const userData = {
                userId: userId,
                userName: userName,
                friends: [],
                pendingRequests: [],
                messages: {}
            };
            
            localStorage.setItem('wifiChatUser', JSON.stringify(userData));
            
            // Register user in network
            appState.networkUsers[userId] = {
                name: userName,
                lastSeen: Date.now()
            };
            
            showDashboard();
        }

        // Check if user ID is already taken
        function isUserIdTaken(userId) {
            // Check if this ID exists in our network users
            return appState.networkUsers.hasOwnProperty(userId);
        }

        // Show dashboard
        function showDashboard() {
            registerScreen.classList.add('hidden');
            chatScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            
            // Update user info
            userNameDisplay.textContent = appState.userName;
            userIdDisplay.textContent = appState.userId;
            
            // Update friends list
            updateFriendsList();
            
            // Update pending requests
            updatePendingRequests();
        }

        // Switch between tabs
        function switchTab(tab) {
            if (tab === 'friends') {
                friendsTab.className = 'flex-1 py-3 text-center font-medium text-blue-600 border-b-2 border-blue-500';
                addFriendTab.className = 'flex-1 py-3 text-center font-medium text-gray-500';
                friendsListContainer.classList.remove('hidden');
                addFriendContainer.classList.add('hidden');
            } else {
                friendsTab.className = 'flex-1 py-3 text-center font-medium text-gray-500';
                addFriendTab.className = 'flex-1 py-3 text-center font-medium text-blue-600 border-b-2 border-blue-500';
                friendsListContainer.classList.add('hidden');
                addFriendContainer.classList.remove('hidden');
            }
        }

        // Update friends list
        function updateFriendsList() {
            friendsList.innerHTML = '';
            
            if (appState.friends.length === 0) {
                noFriendsMessage.classList.remove('hidden');
                return;
            }
            
            noFriendsMessage.classList.add('hidden');
            
            appState.friends.forEach(friend => {
                const isOnline = appState.onlineUsers.some(user => user.id === friend.id);
                
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item p-3 border border-gray-200 rounded-lg flex items-center justify-between cursor-pointer hover:bg-gray-50 transition';
                friendItem.addEventListener('click', () => startChat(friend));
                
                friendItem.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-semibold mr-3">
                            ${friend.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h4 class="font-medium">${friend.name}</h4>
                            <p class="text-xs text-gray-500 flex items-center">
                                <span class="w-2 h-2 rounded-full mr-1 ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></span>
                                ${isOnline ? 'Online' : 'Offline'}
                            </p>
                        </div>
                    </div>
                    <div class="text-blue-500">
                        <i class="fas fa-comment"></i>
                    </div>
                `;
                
                friendsList.appendChild(friendItem);
            });
        }

        // Update pending requests
        function updatePendingRequests() {
            pendingRequestsList.innerHTML = '';
            
            if (appState.pendingRequests.length === 0) {
                noPendingRequests.classList.remove('hidden');
                return;
            }
            
            noPendingRequests.classList.add('hidden');
            
            appState.pendingRequests.forEach(request => {
                const requestItem = document.createElement('div');
                requestItem.className = 'p-3 border border-gray-200 rounded-lg flex items-center justify-between';
                
                requestItem.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-semibold mr-3">
                            ${request.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h4 class="font-medium">${request.name}</h4>
                            <p class="text-xs text-gray-500">ID: ${request.id}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="accept-request bg-green-500 hover:bg-green-600 text-white p-2 rounded-full transition" data-id="${request.id}">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="reject-request bg-red-500 hover:bg-red-600 text-white p-2 rounded-full transition" data-id="${request.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                pendingRequestsList.appendChild(requestItem);
            });
            
            // Add event listeners to accept/reject buttons
            document.querySelectorAll('.accept-request').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const friendId = button.getAttribute('data-id');
                    acceptFriendRequest(friendId);
                });
            });
            
            document.querySelectorAll('.reject-request').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const friendId = button.getAttribute('data-id');
                    rejectFriendRequest(friendId);
                });
            });
        }

        // Handle add friend
        function handleAddFriend(e) {
            e.preventDefault();
            const friendId = friendIdInput.value.trim();
            
            if (friendId.length !== 6) {
                showError('Please enter a valid 6-digit ID');
                return;
            }
            
            if (friendId === appState.userId) {
                showError('You cannot add yourself as a friend!');
                return;
            }
            
            // Check if already friends
            if (appState.friends.some(friend => friend.id === friendId)) {
                showError('This user is already your friend');
                return;
            }
            
            // Check if request already sent
            if (appState.pendingRequests.some(request => request.id === friendId)) {
                showError('Friend request already sent');
                return;
            }
            
            // Validate if user exists in network
            validateUserExists(friendId)
                .then(userExists => {
                    if (userExists) {
                        // Send friend request
                        sendFriendRequest(friendId);
                        friendIdInput.value = '';
                        hideError();
                    } else {
                        showError('User ID not found. Please check the ID and try again.');
                    }
                })
                .catch(() => {
                    showError('Unable to validate user. Please try again.');
                });
        }

        // Validate if user exists in network
        function validateUserExists(userId) {
            return new Promise((resolve) => {
                // First check our local cache
                if (appState.networkUsers[userId]) {
                    resolve(true);
                    return;
                }
                
                // Send validation request to the network
                const requestId = Date.now().toString();
                
                // Set up response listener
                const responseListener = (e) => {
                    if (e.key && e.key.startsWith('wifiChat_')) {
                        try {
                            const message = JSON.parse(e.newValue);
                            if (message && message.type === 'userValidation' && 
                                message.requestId === requestId && message.senderId === userId) {
                                window.removeEventListener('storage', responseListener);
                                resolve(message.data === 'userExists');
                            }
                        } catch (error) {
                            // Ignore errors
                        }
                    }
                };
                
                window.addEventListener('storage', responseListener);
                
                // Send validation request
                sendNetworkMessage({
                    type: 'userValidation',
                    data: 'validateUser',
                    senderId: appState.userId,
                    targetId: userId,
                    requestId: requestId
                });
                
                // Timeout after 3 seconds
                setTimeout(() => {
                    window.removeEventListener('storage', responseListener);
                    resolve(false);
                }, 3000);
            });
        }

        // Handle user validation response
        function handleUserValidationResponse(requestId, userExists) {
            // This would be used if we need to respond to validation requests
            // Currently handled in the network message processing
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            friendIdError.classList.remove('hidden');
            friendIdInput.classList.add('border-red-500', 'shake');
            setTimeout(() => friendIdInput.classList.remove('shake'), 500);
        }

        // Hide error message
        function hideError() {
            friendIdError.classList.add('hidden');
            friendIdInput.classList.remove('border-red-500');
        }

        // Send friend request
        function sendFriendRequest(friendId) {
            sendNetworkMessage({
                type: 'friendRequest',
                senderId: appState.userId,
                senderName: appState.userName,
                targetId: friendId
            });
            
            showNotification('Friend request sent successfully!', 'success');
        }

        // Receive friend request
        function receiveFriendRequest(senderId, senderName) {
            // Check if already friends
            if (appState.friends.some(friend => friend.id === senderId)) {
                return;
            }
            
            // Check if request already exists
            if (appState.pendingRequests.some(request => request.id === senderId)) {
                return;
            }
            
            // Add to pending requests
            appState.pendingRequests.push({
                id: senderId,
                name: senderName
            });
            
            // Update storage
            updateUserStorage();
            
            // Update UI
            updatePendingRequests();
            
            showNotification(`New friend request from ${senderName} (ID: ${senderId})`, 'info');
            
            // Switch to add friend tab to show the pending request
            switchTab('addFriend');
        }

        // Accept friend request
        function acceptFriendRequest(friendId) {
            // Find the request
            const requestIndex = appState.pendingRequests.findIndex(request => request.id === friendId);
            if (requestIndex === -1) return;
            
            const friend = appState.pendingRequests[requestIndex];
            
            // Remove from pending requests
            appState.pendingRequests.splice(requestIndex, 1);
            
            // Add to friends
            appState.friends.push({
                id: friend.id,
                name: friend.name
            });
            
            // Update storage
            updateUserStorage();
            
            // Update UI
            updatePendingRequests();
            updateFriendsList();
            
            // Notify the sender that request was accepted
            sendNetworkMessage({
                type: 'friendRequestAccepted',
                senderId: appState.userId,
                senderName: appState.userName,
                targetId: friend.id
            });
            
            showNotification(`You are now friends with ${friend.name}`, 'success');
        }

        // Reject friend request
        function rejectFriendRequest(friendId) {
            // Find the request
            const requestIndex = appState.pendingRequests.findIndex(request => request.id === friendId);
            if (requestIndex === -1) return;
            
            const friend = appState.pendingRequests[requestIndex];
            
            // Remove from pending requests
            appState.pendingRequests.splice(requestIndex, 1);
            
            // Update storage
            updateUserStorage();
            
            // Update UI
            updatePendingRequests();
            
            showNotification(`Friend request from ${friend.name} rejected`, 'info');
        }

        // Handle friend request accepted
        function handleFriendRequestAccepted(senderId, senderName) {
            // Check if already friends
            if (appState.friends.some(friend => friend.id === senderId)) {
                return;
            }
            
            // Add to friends
            appState.friends.push({
                id: senderId,
                name: senderName
            });
            
            // Update storage
            updateUserStorage();
            
            // Update UI
            updateFriendsList();
            
            showNotification(`You are now friends with ${senderName}`, 'success');
        }

        // Start chat with friend
        function startChat(friend) {
            appState.currentChatPartner = friend;
            
            // Update chat UI
            chatPartnerName.textContent = friend.name;
            chatPartnerId.textContent = friend.id;
            
            // Update connection status
            updateChatConnectionStatus();
            
            // Show chat screen
            dashboardScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            
            // Load messages
            loadMessages();
            
            // Focus on message input if partner is online
            const isOnline = appState.onlineUsers.some(user => user.id === friend.id);
            if (isOnline) {
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        // Update chat connection status
        function updateChatConnectionStatus() {
            if (!appState.currentChatPartner) return;
            
            const isOnline = appState.onlineUsers.some(user => user.id === appState.currentChatPartner.id);
            const isSameWifi = appState.isConnectedToWifi;
            
            if (isOnline && isSameWifi) {
                chatConnectionIndicator.className = "w-3 h-3 bg-green-400 rounded-full pulse-online";
                chatConnectionStatus.textContent = "Online";
                partnerStatus.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span><span>Online</span>`;
                
                // Enable message input
                messageInput.disabled = false;
                messageInput.placeholder = "Type a message...";
                sendButton.className = "bg-blue-500 hover:bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center transition";
                sendButton.disabled = false;
            } else {
                chatConnectionIndicator.className = "w-3 h-3 bg-gray-400 rounded-full";
                chatConnectionStatus.textContent = "Offline";
                partnerStatus.innerHTML = `<span class="w-2 h-2 bg-gray-400 rounded-full mr-1"></span><span>Offline</span>`;
                
                // Disable message input
                messageInput.disabled = true;
                messageInput.placeholder = "Friend is offline";
                sendButton.className = "bg-gray-400 text-white rounded-full w-12 h-12 flex items-center justify-center transition";
                sendButton.disabled = true;
            }
        }

        // Load messages for current chat
        function loadMessages() {
            if (!appState.currentChatPartner) return;
            
            messagesContainer.innerHTML = '';
            
            const chatId = getChatId(appState.currentChatPartner.id);
            const messages = appState.messages[chatId] || [];
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-8">
                        <i class="fas fa-comment-dots text-3xl mb-3 block text-blue-300"></i>
                        <p>No messages yet. Start a conversation!</p>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                displayMessage(message);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send a message
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !appState.currentChatPartner) return;
            
            // Create message object
            const message = {
                id: Date.now(),
                senderId: appState.userId,
                text: text,
                timestamp: new Date(),
                type: 'sent'
            };
            
            // Add to messages
            const chatId = getChatId(appState.currentChatPartner.id);
            if (!appState.messages[chatId]) {
                appState.messages[chatId] = [];
            }
            appState.messages[chatId].push(message);
            
            // Update storage
            updateUserStorage();
            
            // Display message
            displayMessage(message);
            
            // Clear input
            messageInput.value = '';
            
            // Send via network
            sendNetworkMessage({
                type: 'chat',
                data: message,
                senderId: appState.userId,
                senderName: appState.userName,
                targetId: appState.currentChatPartner.id
            });
            
            // Clear typing indicator
            clearTypingIndicator();
        }

        // Send message via network
        function sendNetworkMessage(message) {
            const key = `wifiChat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            localStorage.setItem(key, JSON.stringify(message));
            
            // Trigger storage event for other tabs
            window.dispatchEvent(new Event('storage'));
        }

        // Receive a message
        function receiveMessage(message) {
            // Only process if we're chatting with this user
            if (!appState.currentChatPartner || appState.currentChatPartner.id !== message.senderId) {
                // Still store the message for later
                const chatId = getChatId(message.senderId);
                if (!appState.messages[chatId]) {
                    appState.messages[chatId] = [];
                }
                appState.messages[chatId].push({
                    ...message,
                    type: 'received'
                });
                
                updateUserStorage();
                return;
            }
            
            // Mark as received
            message.type = 'received';
            
            // Add to messages
            const chatId = getChatId(message.senderId);
            if (!appState.messages[chatId]) {
                appState.messages[chatId] = [];
            }
            appState.messages[chatId].push(message);
            
            // Update storage
            updateUserStorage();
            
            // Display message if we're in the chat
            if (appState.currentChatPartner && appState.currentChatPartner.id === message.senderId) {
                displayMessage(message);
            }
            
            // Show notification if tab is not active
            if (document.hidden) {
                showNotification(`New message from ${message.senderId === appState.userId ? 'You' : appState.currentChatPartner.name}`, 'info');
            }
        }

        // Handle typing indicator
        function handleTyping() {
            if (!appState.currentChatPartner) return;
            
            // Send typing indicator
            sendNetworkMessage({
                type: 'typing',
                senderId: appState.userId,
                senderName: appState.userName,
                targetId: appState.currentChatPartner.id
            });
            
            // Clear previous timeout
            if (appState.typingTimeout) {
                clearTimeout(appState.typingTimeout);
            }
            
            // Set timeout to clear typing indicator
            appState.typingTimeout = setTimeout(() => {
                clearTypingIndicator();
            }, 2000);
        }

        // Show typing indicator
        function showTypingIndicator(partnerId, partnerName) {
            if (appState.currentChatPartner && appState.currentChatPartner.id === partnerId) {
                typingPartnerName.textContent = partnerName;
                typingIndicator.classList.remove('hidden');
                
                // Auto-hide after 3 seconds
                setTimeout(() => {
                    typingIndicator.classList.add('hidden');
                }, 3000);
            }
        }

        // Clear typing indicator
        function clearTypingIndicator() {
            typingIndicator.classList.add('hidden');
        }

        // Display a message in the chat
        function displayMessage(message) {
            // Remove the "no messages" placeholder if it exists
            const placeholder = messagesContainer.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `slide-up flex ${message.senderId === appState.userId ? 'justify-end' : 'justify-start'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs lg:max-w-md px-4 py-2 ${message.senderId === appState.userId ? 'message-sent' : 'message-received'} shadow-sm`;
            
            const messageText = document.createElement('p');
            messageText.className = 'text-sm';
            messageText.textContent = message.text;
            
            const messageTime = document.createElement('p');
            messageTime.className = `text-xs mt-1 ${message.senderId === appState.userId ? 'text-blue-100' : 'text-gray-500'} text-right`;
            messageTime.textContent = formatTime(message.timestamp);
            
            messageBubble.appendChild(messageText);
            messageBubble.appendChild(messageTime);
            messageDiv.appendChild(messageBubble);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Get chat ID for storage
        function getChatId(partnerId) {
            return [appState.userId, partnerId].sort().join('_');
        }

        // Update user data in storage
        function updateUserStorage() {
            const userData = {
                userId: appState.userId,
                userName: appState.userName,
                friends: appState.friends,
                pendingRequests: appState.pendingRequests,
                messages: appState.messages
            };
            
            localStorage.setItem('wifiChatUser', JSON.stringify(userData));
        }

        // Format time for display
        function formatTime(date) {
            return new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white max-w-sm z-50 slide-up ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
